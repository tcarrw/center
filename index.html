<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Center ¬∑ Cube Keys ‚Üí School Proximity</title>
<style>
  :root{
    --bg: radial-gradient(1200px 800px at 70% -20%, rgba(255,182,193,0.22), transparent),
          radial-gradient(900px 600px at 0% 120%, rgba(182,139,255,0.18), transparent),
          radial-gradient(700px 500px at 100% 100%, rgba(255,236,179,0.14), transparent),
          #0a0a0f;
    --text:#eef1ff; --muted:#c9cbe4;
    --pink:#ff7fb7; --gold:#ffd76a; --violet:#b68cff; --blue:#98c8ff; --green:#9af2c9; --yellow:#fff79a;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    display:flex; align-items:flex-start; justify-content:center; padding:34px 14px 14px; /* more top padding */
  }
  .wrap{width:min(1100px,100%); display:grid; gap:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
    border:1px solid rgba(255,255,255,0.12);
    border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
    backdrop-filter: blur(8px);
  }
  .eyebrow{font-size:11px; letter-spacing:.25em; text-transform:uppercase; color:var(--muted); margin:12px 12px 4px}
  .title{
    font-weight:700; font-size:20px; margin:0 12px 6px;
    background:linear-gradient(90deg, var(--pink), var(--gold));
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .topline{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 12px 8px}
  .itime{
    font-size:12.5px; color:#f6f7ff; padding:6px 10px; border-radius:999px;
    background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.16);
  }

  .grid{padding:12px; display:grid; grid-template-columns:1.15fr .85fr; gap:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}

  /* Cube area */
  .cube-wrap{
    position:relative; border:1px solid rgba(255,255,255,0.10); border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    padding:6px;
  }
  svg{width:100%; height:auto; display:block}
  .face{fill:rgba(255,255,255,0.04); stroke:rgba(255,255,255,0.06)}
  .edge{stroke:rgba(255,255,255,0.28); stroke-width:1.1}
  .edge.dim{opacity:.28}

  /* Garlic/Clarity plane visuals */
  .plane{fill:var(--yellow); opacity:0; fill-opacity:.12; stroke:rgba(255,255,210,.45); stroke-dasharray:5 6; transition:opacity .25s ease}
  .plane.on{opacity:1}
  .diag{stroke:var(--yellow); stroke-width:1.6; stroke-linecap:round; opacity:0; filter:url(#g)}
  .diag.on{opacity:.85}

  .node{pointer-events:auto; cursor:default}
  .node circle{stroke:rgba(255,255,255,0.65); stroke-width:1.1}
  .node.dim circle{opacity:.35; filter:grayscale(.8)}
  .glow{filter:url(#g)}
  .label{font-size:12px; fill:#e9ecff; paint-order:stroke; stroke:#0a0a0f; stroke-width:.6px; letter-spacing:.2px}
  .badge-emoji{font-size:14px; paint-order:stroke; stroke:#0a0a0f; stroke-width:.6px}
  .center-dot{fill:#fff; opacity:.9}
  .center-pulse{fill:rgba(255,215,106,0.32); animation:pulse 2.6s ease-in-out infinite}
  @keyframes pulse{0%{transform:scale(.96)}50%{transform:scale(1.04)}100%{transform:scale(.96)}}

  /* Right info */
  .side{
    display:grid; gap:10px; align-content:start; padding:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
    border:1px solid rgba(255,255,255,0.10); border-radius:12px;
  }
  .stat{
    display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted);
    background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.10);
    border-radius:10px; padding:8px 10px
  }
  .stat b{color:#fff}
  .feedback{
    font-size:13px; line-height:1.45; color:#f2f2ff; background: rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.10); border-radius:10px; padding:10px
  }

  /* Hint box */
  .hint{
    font-size:12.5px; line-height:1.5; color:#f6f7ff;
    background:linear-gradient(180deg, rgba(255,255,210,0.10), rgba(255,255,255,0.04));
    border:1px solid rgba(255,255,210,0.35);
    border-radius:10px; padding:10px;
  }
  .hint b{color:#fff}
  .hint ul{margin:8px 0 0 18px; padding:0}
  .hint li{margin:4px 0}

  /* Keys list */
  .keys{
    display:grid; gap:8px; padding:8px; background: rgba(255,255,255,0.04);
    border:1px solid rgba(255,255,255,0.10); border-radius:10px
  }
  .key-row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  @media (max-width:700px){.key-row{grid-template-columns:1fr}}
  .key{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12); transition:opacity .25s ease, filter .25s ease
  }
  .key.dim{opacity:.45; filter:grayscale(.7)}
  .left{display:flex; align-items:center; gap:8px}
  .dot{width:9px; height:9px; border-radius:50%}
  .p{background:var(--pink)} .g{background:var(--gold)} .v{background:var(--violet)} .b{background:var(--blue)} .gr{background:var(--green)} .y{background:var(--yellow)}
  .titlekey{font-size:12.5px; color:#fff; font-weight:600; letter-spacing:.2px}
  .method{display:inline-flex; align-items:center; gap:6px}
  .badge{font-size:11px; padding:3px 7px; border-radius:999px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.16)}
  .edit{font-size:11px; padding:5px 8px; border-radius:999px; color:#0a0a0f; background:#fff; border:none; cursor:pointer}
  .edit[disabled]{opacity:.5; cursor:not-allowed}
  .selector{display:none; margin-top:6px; padding:8px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px}
  .selector label{display:inline-flex; align-items:center; gap:6px; margin:4px 8px 0 0; font-size:12px; color:#e9ecff}
  .selector input{accent-color:#ffd76a}

  .missing{display:flex; gap:6px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
  .chip{display:inline-flex; gap:6px; align-items:center; padding:5px 8px; border-radius:999px;
        background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.12)}
  .fine{font-size:11px; color:var(--muted); text-align:center; padding-bottom:2px}

  /* Reality Anchor chip + overlay */
  .ra-chip{
    position:fixed; left:14px; bottom:14px; z-index:60;
    padding:10px 12px; border-radius:999px;
    background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
    border:1px solid rgba(255,255,255,0.18);
    color:#eef1ff; font-size:12.5px; letter-spacing:.06em; text-transform:uppercase;
    backdrop-filter: blur(8px);
  }
  .ra-chip:active{transform:translateY(1px)}
  .ra-overlay{
    position:fixed; inset:0; z-index:70; display:none;
    background: rgba(10,10,15,0.55);
    backdrop-filter: blur(4px);
  }
  .ra-panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(520px,92%); border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.05));
    border:1px solid rgba(255,255,255,0.16);
    padding:16px; text-align:center;
  }
  .ra-eyebrow{font-size:11px; letter-spacing:.25em; color:#c9cbe4; text-transform:uppercase; margin-bottom:6px}
  .ra-title{
    margin:0 0 10px 0; font-weight:700; font-size:18px;
    background: linear-gradient(90deg, #ffd76a, #b68cff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }
  .ra-steps{display:grid; gap:8px; margin:10px 0 12px 0}
  .ra-step{
    font-size:15px; line-height:1.5; color:#f2f2ff;
    padding:10px; border-radius:12px;
    background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
    opacity:.55;
    transition: opacity .25s ease, transform .25s ease;
  }
  .ra-step.on{opacity:1; transform:scale(1.01)}
  .ra-controls{display:flex; gap:8px; justify-content:center}
  .ra-btn{
    padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.18);
    background:#fff; color:#0a0a0f; font-size:13px; cursor:pointer;
  }
  .ra-btn.secondary{
    background: rgba(255,255,255,0.06); color:#eef1ff;
    border:1px solid rgba(255,255,255,0.14);
  }
  .ra-ring{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:40vmin; height:40vmin; border-radius:50%;
    box-shadow: 0 0 0 0 rgba(255,215,106,0.0);
    pointer-events:none;
  }
  .ra-ring.on{ animation: raPulse 2.2s ease-out 1; }
  @keyframes raPulse{
    0%{box-shadow:0 0 0 0 rgba(255,215,106,0.00)}
    40%{box-shadow:0 0 0 18vmin rgba(255,215,106,0.22)}
    100%{box-shadow:0 0 0 0 rgba(255,215,106,0.00)}
  }

  /* Tooltip for Clarity hint puck */
  .tip{
    position:absolute; padding:8px 10px; font-size:12px; line-height:1.4;
    color:#f6f7ff; background:rgba(10,10,15,0.8); border:1px solid rgba(255,255,255,0.18);
    border-radius:8px; transform:translate(-50%,-110%); white-space:nowrap; pointer-events:none; opacity:0;
    transition:opacity .2s ease;
  }
  .puck:hover + .tip, .puck:focus + .tip{opacity:1}
  .puck{
    position:absolute; width:16px; height:16px; border-radius:50%;
    background: rgba(255,255,210,0.85); border:1px solid rgba(0,0,0,0.5);
    display:grid; place-items:center; font-size:11px; color:#0a0a0f; cursor:pointer;
  }
</style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <div class="eyebrow">Center</div>
      <div class="topline">
        <h1 class="title">Cube Keys ‚Üí Proximity to School</h1>
        <div class="itime" id="illuminaTime">Illumina time ‚Äî calculating‚Ä¶</div>
      </div>
      <div class="grid">
        <div class="cube-wrap">
          <!-- Trimmed viewBox height to tighten padding -->
          <svg viewBox="0 0 600 440" preserveAspectRatio="xMidYMid meet" aria-label="Cube map">
            <defs>
              <filter id="g"><feGaussianBlur in="SourceGraphic" stdDeviation="2"/></filter>
            </defs>

            <!-- Faces (three sides) -->
            <polygon class="face" points="150,120 300,50 450,120 300,190"/>
            <polygon class="face" points="150,120 150,300 300,360 300,190"/>
            <polygon class="face" points="300,190 300,360 450,300 450,120"/>

            <!-- Edges -->
            <g id="edges" fill="none">
              <line class="edge" x1="150" y1="120" x2="300" y2="50"/>
              <line class="edge" x1="300" y1="50"  x2="450" y2="120"/>
              <line class="edge" x1="450" y1="120" x2="300" y2="190"/>
              <line class="edge" x1="300" y1="190" x2="150" y2="120"/>
              <line class="edge" x1="150" y1="300" x2="300" y2="230"/>
              <line class="edge" x1="300" y1="230" x2="450" y2="300"/>
              <line class="edge" x1="450" y1="300" x2="300" y2="360"/>
              <line class="edge" x1="300" y1="360" x2="150" y2="300"/>
              <line class="edge" x1="150" y1="120" x2="150" y2="300"/>
              <line class="edge" x1="300" y1="50"  x2="300" y2="230"/>
              <line class="edge" x1="450" y1="120" x2="450" y2="300"/>
              <line class="edge" x1="300" y1="190" x2="300" y2="360"/>
            </g>

            <!-- Clarity plane (triangle: Clarity ‚Üí Four ‚Üí MirrorHoney) -->
            <polygon id="clarityPlane" class="plane" points="450,120 300,230 150,300"/>

            <!-- Plane edges -->
            <line id="diagClarityToFour" class="diag" x1="450" y1="120" x2="300" y2="230"/>
            <line id="diagClarityToMH"   class="diag" x1="450" y1="120" x2="150" y2="300"/>

            <!-- Center point -->
            <circle id="centerPulse" class="center-pulse glow" cx="300" cy="208" r="30"/>
            <circle class="center-dot glow" cx="300" cy="208" r="5"/>

            <!-- Nodes (8 vertices) -->
            <g id="nodes">
              <!-- top rim -->
              <g class="node" data-key="honey" transform="translate(150,120)">
                <circle r="9" fill="#ff7fb7"/><text class="label" x="12" y="4">Honey</text>
              </g>
              <g class="node" data-key="froot" transform="translate(300,50)">
                <circle r="9" fill="#9af2c9"/><text class="label" x="12" y="4">Froot</text>
              </g>
              <g class="node" data-key="clarity" transform="translate(450,120)">
                <circle id="clarityDot" r="9" fill="#fff79a"/><text class="label" x="12" y="4">Clarity</text>
                <text id="garlicBadge" class="badge-emoji" x="58" y="4" opacity="0">üßÑ</text>
              </g>
              <g class="node" data-key="voice" transform="translate(300,190)">
                <circle r="9" fill="#b68cff"/><text class="label" x="12" y="4">Voice</text>
              </g>
              <!-- bottom rim -->
              <g class="node" data-key="mirrorhoney" transform="translate(150,300)">
                <circle r="9" fill="#b68cff"/><text class="label" x="12" y="4">MirrorHoney</text>
              </g>
              <g class="node" data-key="four" transform="translate(300,230)">
                <circle r="9" fill="#9af2c9"/><text class="label" x="12" y="4">Four</text>
              </g>
              <g class="node" data-key="wonder" transform="translate(450,300)">
                <circle r="9" fill="#ff7fb7"/><text class="label" x="12" y="4">Wonder ¬∑ Dua</text>
              </g>
              <g class="node" data-key="dagny" transform="translate(300,360)">
                <circle r="9" fill="#ff7fb7"/><text class="label" x="12" y="4">Bridge of Joy</text>
              </g>
            </g>

            <!-- Tiny hint puck near Clarity -->
            <g transform="translate(470,105)">
              <foreignObject width="150" height="70">
                <div xmlns="http://www.w3.org/1999/xhtml" style="position:relative;">
                  <button class="puck" id="clarityPuck" tabindex="0" aria-label="Hint for Clarity">?</button>
                  <div class="tip" id="clarityTip">Clarity appears after one honest line + a MirrorHoney note. Click to check &amp; claim.</div>
                </div>
              </foreignObject>
            </g>

          </svg>
        </div>

        <div class="side">
          <div class="eyebrow">School Proximity</div>
          <div class="stat"><span>Progress</span><b id="progressPct">0%</b></div>
          <div class="stat"><span>Keys</span><b id="keysCount">0 / 8</b></div>
          <div class="feedback" id="feedback">Collect keys. Keys only light up if held on your device.</div>

          <div class="hint">
            <b>How to find Clarity (Garlic):</b>
            <ul>
              <li>Write one honest sentence you‚Äôve been avoiding.</li>
              <li>Save it as a MirrorHoney note.</li>
              <li>Then hold <b>Clarity</b> here and tag how you got it (üß≠ found / ‚≠ê earned).</li>
            </ul>
          </div>

          <div class="keys">
            <div class="key-row" id="keyRow"></div>
            <div class="fine">Long-press a card to toggle held. Tap a lit card to set how it was obtained.</div>
          </div>

          <div class="missing" id="missingBox"></div>
          <div class="fine">When Clarity is held, the Garlic plane glows (Clarity ‚Üí Four ‚Üí MirrorHoney).</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Reality Anchor (inline) -->
  <button class="ra-chip" id="raChip" aria-haspopup="dialog" aria-controls="raOverlay">Reality Anchor</button>

  <div class="ra-overlay" id="raOverlay" role="dialog" aria-modal="true" aria-label="Reality Anchor">
    <div class="ra-panel">
      <div class="ra-eyebrow">3-Breath Anchor</div>
      <h3 class="ra-title">steady the mirror</h3>
      <div class="ra-steps">
        <div class="ra-step" id="raStep1">inhale ‚Äî i‚Äôm here</div>
        <div class="ra-step" id="raStep2">exhale ‚Äî i‚Äôm real</div>
        <div class="ra-step" id="raStep3">inhale ‚Äî i can carry this</div>
        <div class="ra-step" id="raStep4">exhale ‚Äî one small move</div>
      </div>
      <div class="ra-controls">
        <button class="ra-btn" id="raStart">begin</button>
        <button class="ra-btn secondary" id="raClose">close</button>
      </div>
    </div>
    <!-- expanding ring over the cube center -->
    <div class="ra-ring" id="raRing"></div>
  </div>

<script>
  /* ---------- Keys state + UI ---------- */
  var KEY_DEFS = [
    {id:"honey",       label:"Honey",        color:"p"},
    {id:"froot",       label:"Froot",        color:"gr"},
    {id:"clarity",     label:"Clarity",      color:"y"},
    {id:"voice",       label:"Voice",        color:"v"},
    {id:"mirrorhoney", label:"MirrorHoney",  color:"v"},
    {id:"four",        label:"Four",         color:"gr"},
    {id:"wonder",      label:"Wonder ¬∑ Dua", color:"p"},
    {id:"dagny",       label:"Bridge of Joy",color:"p"}
  ];
  var METHODS = [
    {id:"found",  label:"found",  badge:"üß≠"},
    {id:"earned", label:"earned", badge:"‚≠ê"},
    {id:"gifted", label:"gifted", badge:"üíù"},
    {id:"echo",   label:"echo",   badge:"üêù"},
    {id:"link",   label:"link",   badge:"‚õìÔ∏è"}
  ];

  var STORAGE_KEY = "center.keys.state";
  function loadState(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");}catch(e){return{}} }
  function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
  function ensureDefaults(){
    var s = loadState();
    KEY_DEFS.forEach(function(k){ if(!s[k.id]) s[k.id] = {held:false, method:"found"}; });
    if(s.earth){ delete s.earth; }
    // Auto-claim Clarity if a MirrorHoney note already exists
    var mh = localStorage.getItem('mirrorhoney.note') || localStorage.getItem('mirrorhoney.last_note');
    if(mh && s.clarity && !s.clarity.held){ s.clarity.held = true; s.clarity.method = "earned"; }
    saveState(s);
  }
  function methodBadge(id){ var m = METHODS.find(function(x){return x.id===id}); return m ? (m.badge+" "+m.label) : ""; }

  var keyRow = document.getElementById("keyRow");
  var pctLabel = document.getElementById("progressPct");
  var keysLabel = document.getElementById("keysCount");
  var feedback = document.getElementById("feedback");
  var missingBox = document.getElementById("missingBox");

  function buildKeys(){
    var s = loadState();
    keyRow.innerHTML = "";
    KEY_DEFS.forEach(function(k){
      var held = s[k.id].held, method = s[k.id].method;
      var card = document.createElement("div");
      card.className = "key" + (held ? "" : " dim");
      card.setAttribute("data-key", k.id);

      var left = document.createElement("div");
      left.className = "left";
      left.innerHTML = '<span class="dot '+k.color+'"></span><span class="titlekey">'+k.label+'</span>';

      var right = document.createElement("div");
      right.className = "method";
      var badge = document.createElement("span");
      badge.className = "badge";
      badge.textContent = held ? methodBadge(method) : "not held";

      var btn = document.createElement("button");
      btn.className = "edit";
      btn.textContent = held ? "edit" : "claim";
      if(!held) btn.setAttribute("disabled","");

      right.appendChild(badge); right.appendChild(btn);

      var selector = document.createElement("div");
      selector.className = "selector";
      ["found","earned","gifted","echo","link"].forEach(function(mid){
        var m = METHODS.find(function(mm){return mm.id===mid;});
        var id = "sel-"+k.id+"-"+m.id;
        var lab = document.createElement("label");
        lab.innerHTML = '<input type="radio" name="method-'+k.id+'" id="'+id+'" value="'+m.id+'" '+(method===m.id?'checked':'')+' />'+m.badge+' '+m.label;
        selector.appendChild(lab);
      });

      btn.addEventListener("click", function(){
        if(!loadState()[k.id].held) return;
        selector.style.display = selector.style.display==="block" ? "none" : "block";
      });
      selector.addEventListener("change", function(e){
        var st = loadState(); st[k.id].method = e.target.value; saveState(st);
        badge.textContent = methodBadge(st[k.id].method); selector.style.display="none"; update();
      });

      var pressTimer;
      card.addEventListener("mousedown", function(){
        pressTimer = setTimeout(function(){
          var st = loadState(); st[k.id].held = !st[k.id].held; saveState(st);
          if(st[k.id].held){ card.classList.remove("dim"); btn.removeAttribute("disabled"); btn.textContent="edit"; badge.textContent=methodBadge(st[k.id].method); }
          else { card.classList.add("dim"); btn.setAttribute("disabled",""); btn.textContent="claim"; badge.textContent="not held"; selector.style.display="none"; }
          update();
        }, 550);
      });
      ["mouseup","mouseleave","touchend","touchcancel"].forEach(function(ev){ card.addEventListener(ev, function(){ clearTimeout(pressTimer); }); });

      card.appendChild(left); card.appendChild(right); card.appendChild(selector);
      keyRow.appendChild(card);
    });
  }

  function computeProximity(){
    var st = loadState();
    var total = KEY_DEFS.length;
    var have = KEY_DEFS.filter(function(k){ return st[k.id].held; }).length;
    var pct = Math.round((have/total)*100);
    return {pct:pct, have:have, total:total};
  }

  function renderMissing(){
    var st = loadState();
    var missing = KEY_DEFS.filter(function(k){ return !st[k.id].held; });
    if(missing.length){
      var html = "Missing keys: " + missing.map(function(k){
        var dot = '<span class="dot '+k.color+'"></span>';
        return '<span class="chip">'+dot+k.label+'</span>';
      }).join(" ");
      missingBox.innerHTML = html;
    }else missingBox.innerHTML = "";
  }

  function setNodeLighting(){
    var st = loadState();
    document.querySelectorAll('#nodes .node').forEach(function(n){
      var id = n.getAttribute('data-key');
      if(st[id] && st[id].held){ n.classList.remove('dim'); n.querySelector('circle').classList.add('glow'); }
      else { n.classList.add('dim'); n.querySelector('circle').classList.remove('glow'); }
    });
    // Garlic badge only when clarity is held
    var garlicBadge = document.getElementById('garlicBadge');
    garlicBadge.setAttribute('opacity', (st.clarity && st.clarity.held) ? '1' : '0');
  }

  function setEdgeBrightness(pct){
    var dim = pct<50;
    document.querySelectorAll('#edges .edge').forEach(function(e){
      if(dim) e.classList.add('dim'); else e.classList.remove('dim');
      e.setAttribute('stroke-width', String(1.1 + (pct/100)*1.0));
    });
    var pulse = document.getElementById('centerPulse');
    pulse.setAttribute('r', String(22 + pct*0.16));
    var dur = 2.8 - pct*0.012; if(dur<1.2) dur=1.2;
    pulse.style.animationDuration = String(dur)+'s';
    pulse.setAttribute('fill', 'rgba(255,215,106,'+(0.22 + pct*0.0035)+')');
  }

  function setClarityPlane(){
    var st = loadState();
    var on = !!(st.clarity && st.clarity.held);
    document.getElementById('clarityPlane').classList.toggle('on', on);
    document.getElementById('diagClarityToFour').classList.toggle('on', on);
    document.getElementById('diagClarityToMH').classList.toggle('on', on);
    var clarityDot = document.getElementById('clarityDot');
    if(on){ clarityDot.classList.add('glow'); } else { clarityDot.classList.remove('glow'); }
  }

  function updateUI(){
    var p = computeProximity();
    pctLabel.textContent = p.pct + "%";
    keysLabel.textContent = p.have + " / " + p.total;
    if(p.pct===0) feedback.textContent = "Collect keys. Keys only light up if held on your device.";
    else if(p.pct<50) feedback.textContent = "You are on the path. Keep gathering keys.";
    else if(p.pct<100) feedback.textContent = "Almost ready. A few keys remain.";
    else feedback.textContent = "All pre keys gathered. School listens for the right holder.";
    renderMissing();
    setNodeLighting();
    setEdgeBrightness(p.pct);
    setClarityPlane();
    renderIlluminaTime();
  }
  function update(){ updateUI(); }

  /* ---------- Illumina Time ---------- */
  // Illumina 1 start: Nov 5, 2025 (full moon) ‚Äî 42-day cycle
  var I_START = new Date('2025-11-05T00:00:00'); // local midnight start
  function renderIlluminaTime(){
    var el = document.getElementById('illuminaTime');
    var now = new Date();
    var dayMS = 24*60*60*1000;
    var diff = Math.floor((now - I_START)/dayMS) + 1; // Day 1 = start day
    if (diff < 1){
      el.textContent = "Illumina 1 ‚Äî Pre-cycle (" + (1 - diff) + " days)";
      return;
    }
    if (diff > 42){
      el.textContent = "Illumina 1 ‚Äî Complete (+" + (diff - 42) + " days)";
      return;
    }
    el.textContent = "Illumina 1 ‚Äî Day " + diff + " of 42";
  }

  /* ---------- Reality Anchor ---------- */
  (function(){
    var chip = document.getElementById('raChip');
    var overlay = document.getElementById('raOverlay');
    var startBtn = document.getElementById('raStart');
    var closeBtn = document.getElementById('raClose');
    var ring = document.getElementById('raRing');
    var steps = [1,2,3,4].map(function(i){ return document.getElementById('raStep'+i); });
    var running = false, timers = [];

    function show(){ overlay.style.display='block'; steps.forEach(function(s){ s.classList.remove('on'); }); }
    function hide(){
      overlay.style.display='none'; running=false;
      timers.forEach(function(t){ clearTimeout(t); }); timers=[];
      steps.forEach(function(s){ s.classList.remove('on'); });
    }
    function highlight(i){
      steps.forEach(function(s){ s.classList.remove('on'); });
      if (steps[i]) steps[i].classList.add('on');
    }
    function logMoonNote(){
      try{
        localStorage.setItem('illumina.moon.last_anchor', String(Date.now()));
        localStorage.setItem('illumina.moon.note', '3-breath anchor completed');
      }catch(e){}
    }
    function pulseRing(){
      ring.classList.remove('on'); void ring.offsetWidth; ring.classList.add('on');
    }
    function run(){
      if (running) return;
      running = true;
      highlight(0);
      timers.push(setTimeout(function(){ highlight(1); }, 3000));
      timers.push(setTimeout(function(){ highlight(2); }, 6000));
      timers.push(setTimeout(function(){ highlight(3); }, 9000));
      timers.push(setTimeout(function(){ pulseRing(); logMoonNote(); running=false; }, 11000));
    }
    chip.addEventListener('click', show);
    closeBtn.addEventListener('click', hide);
    overlay.addEventListener('click', function(e){ if(e.target===overlay) hide(); });
    startBtn.addEventListener('click', run);
  })();

  /* ---------- Clarity puck logic (auto-claim) ---------- */
  (function(){
    var puck = document.getElementById('clarityPuck');
    var tip  = document.getElementById('clarityTip');
    if (!puck) return;
    puck.addEventListener('click', function(){
      var mh = localStorage.getItem('mirrorhoney.note') || localStorage.getItem('mirrorhoney.last_note');
      var state = loadState();
      if (mh){
        if (!state.clarity) state.clarity = {held:false, method:"earned"};
        state.clarity.held = true;
        if (!state.clarity.method) state.clarity.method = "earned";
        saveState(state);
        tip.textContent = "Clarity claimed ‚úì (from MirrorHoney note)";
        update();
      } else {
        tip.textContent = "No MirrorHoney note detected yet ‚Äî write one line there, then click again.";
        setTimeout(function(){ tip.textContent = "Clarity appears after one honest line + a MirrorHoney note. Click to check & claim."; }, 4000);
      }
    });
  })();

  /* ---------- Init ---------- */
  (function init(){
    ensureDefaults();
    buildKeys();
    update();
  })();
</script>
</body>
</html>
